name: Deploy Portfolio to AWS (OIDC)

# TRIGGER: Run workflow on push to develop or main branches
on:
  push:
    branches:
      - develop
      - main

# PERMISSIONS: Required for OIDC authentication (JWT request)
permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout

# GLOBAL ENVIRONMENT VARIABLES
env:
  AWS_REGION: us-east-1
  # Ensure this matches your Terraform output 'bucket_name'
  S3_BUCKET_NAME: "gpdlportfolio.shop" 

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------
      # 1. CHECKOUT CODE
      # -------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -------------------------------------------------------
      # 2. SETUP PYTHON & MKDOCS
      # -------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build MkDocs Static Site
        run: mkdocs build
        # This generates the static HTML files in the './site' directory

      # -------------------------------------------------------
      # 3. AUTHENTICATE WITH AWS (OIDC - KEYLESS)
      # -------------------------------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          # No long-lived keys (AKIA...) needed here! 

      # -------------------------------------------------------
      # 4. DEPLOY TO S3
      # -------------------------------------------------------
      - name: Sync to S3 Bucket
        run: |
          # Syncs the build folder to S3 and deletes removed files
          aws s3 sync ./site s3://${{ env.S3_BUCKET_NAME }} --delete

      # -------------------------------------------------------
      # 5. INVALIDATE CACHE
      # -------------------------------------------------------
      - name: Invalidate CloudFront Cache
        run: |
          # Forces CloudFront to fetch the new index.html immediately
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
